<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üë∂ NORI APP</title>

  <style>
    :root{
      --bg: #fbfaf6;
      --surface: #ffffff;
      --surface-2: #f6f6f6;
      --text: #1f2121;
      --muted: rgba(98,108,113,.9);
      --border: rgba(94,82,64,.18);

      --primary: #21808d;
      --primary-2: #1d7480;

      --purple: #a855f7;
      --pink: #db2777;
      --blue: #3b82f6;
      --orange: #f97316;
      --green: #22c55e;

      --r: 14px;
      --r2: 18px;

      --s8: 8px;
      --s10: 10px;
      --s12: 12px;
      --s14: 14px;
      --s16: 16px;
      --s18: 18px;
      --s20: 20px;
      --s24: 24px;

      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --shadow2: 0 6px 14px rgba(0,0,0,.07);
      --shadow3: 0 2px 8px rgba(0,0,0,.06);

      --tap: 0.97;
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --bg: #1f2121;
        --surface: #262828;
        --surface-2: #2f3232;
        --text: #f5f5f5;
        --muted: rgba(167,169,169,.82);
        --border: rgba(255,255,255,.14);

        --shadow: 0 12px 28px rgba(0,0,0,.35);
        --shadow2: 0 8px 18px rgba(0,0,0,.35);
        --shadow3: 0 2px 10px rgba(0,0,0,.28);
      }
    }

    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%;}
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(33,128,141,.12), transparent 50%),
                  radial-gradient(900px 600px at 90% 10%, rgba(168,85,247,.10), transparent 50%),
                  var(--bg);
      color: var(--text);
      padding-bottom: 86px;
      overflow-x:hidden;
    }

    /* ----------- HEADER ----------- */
    .topbar{
      position: sticky;
      top:0;
      z-index: 120;
      padding: var(--s14) var(--s16) var(--s12);
      background:
        linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.70));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    @media (prefers-color-scheme: dark){
      .topbar{
        background: linear-gradient(180deg, rgba(38,40,40,.88), rgba(38,40,40,.74));
      }
    }

    .topbar-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s12);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .brand h1{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
      color: var(--primary);
      display:flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow3);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .pill strong{ color: var(--text); font-weight: 700; }

    .topbar-stats{
      margin-top: var(--s10);
      display:flex;
      gap: var(--s10);
      flex-wrap: wrap;
    }

    /* ----------- LAYOUT ----------- */
    .wrap{
      padding: var(--s16);
      display:flex;
      flex-direction:column;
      gap: var(--s16);
    }

    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: var(--s14) var(--s16);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--s10);
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(33,128,141,.06), transparent);
    }
    .card-h h2{
      font-size: 15px;
      font-weight: 800;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .link{
      font-size: 13px;
      color: var(--primary);
      font-weight: 700;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
    }
    .card-b{
      padding: var(--s16);
    }

    /* ----------- HOME: QUICK ACTIONS ----------- */
    .grid-actions{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--s12);
    }
    @media (max-width: 380px){
      .grid-actions{ grid-template-columns: repeat(2, 1fr); }
    }

    .action{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r2);
      padding: var(--s14);
      box-shadow: var(--shadow2);
      display:flex;
      flex-direction:column;
      gap: 6px;
      cursor:pointer;
      user-select:none;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    .action:active{ transform: scale(var(--tap)); }

    .action .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .action .ico{
      font-size: 26px;
      line-height: 1;
    }
    .action .label{
      font-size: 13px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .action .sub{
      font-size: 11px;
      color: var(--muted);
      line-height: 1.25;
      min-height: 14px;
    }

    .accent{
      position:absolute;
      inset:auto -30px -30px auto;
      width: 90px;
      height: 90px;
      border-radius: 999px;
      filter: blur(0px);
      opacity:.12;
      transform: rotate(20deg);
    }

    .a-sleep .label{ color: var(--purple); }
    .a-feeding .label{ color: var(--pink); }
    .a-diaper .label{ color: var(--blue); }
    .a-bath .label{ color: var(--primary); }
    .a-medicine .label{ color: var(--orange); }
    .a-colic .label{ color: var(--orange); }

    .a-sleep .accent{ background: var(--purple); }
    .a-feeding .accent{ background: var(--pink); }
    .a-diaper .accent{ background: var(--blue); }
    .a-bath .accent{ background: var(--primary); }
    .a-medicine .accent{ background: var(--orange); }
    .a-colic .accent{ background: var(--orange); }

    /* ----------- HOME: NOW / LAST ----------- */
    .status-wrap{
      display:flex;
      flex-direction:column;
      gap: var(--s12);
    }

    .status{
      display:flex;
      gap: var(--s12);
      padding: var(--s14);
      border-radius: var(--r2);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(0,0,0,.02), transparent);
    }
    @media (prefers-color-scheme: dark){
      .status{ background: linear-gradient(180deg, rgba(255,255,255,.03), transparent); }
    }

    .status .big{
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 26px;
      flex-shrink:0;
      background: rgba(33,128,141,.10);
      color: var(--primary);
    }

    .status .txt{
      min-width:0;
      flex:1;
    }
    .status .txt .t{
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 2px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .status .txt .d{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .chip{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-weight: 800;
      white-space:nowrap;
    }
    .chip.live{ color: var(--text); }
    .chip.live.purple{ border-color: rgba(168,85,247,.35); background: rgba(168,85,247,.12); }
    .chip.live.pink{ border-color: rgba(219,39,119,.35); background: rgba(219,39,119,.12); }

    /* ----------- LIST ITEMS ----------- */
    .list{
      display:flex;
      flex-direction:column;
      gap: var(--s10);
    }
    .item{
      display:flex;
      gap: var(--s12);
      padding: var(--s12);
      border-radius: var(--r);
      border: 1px solid var(--border);
      background: var(--surface-2);
      align-items:flex-start;
    }
    .item .ic{
      width: 40px; height: 40px;
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      font-size: 22px;
      flex-shrink:0;
      background: rgba(33,128,141,.10);
      color: var(--primary);
    }
    .item .c{ flex:1; min-width:0; }
    .item .c .tt{
      font-size: 13px;
      font-weight: 900;
      letter-spacing:.2px;
      margin-bottom: 2px;
    }
    .item .c .dd{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      word-break: break-word;
    }
    .item .time{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      margin-left: 6px;
      font-weight: 800;
    }

    /* ----------- HISTORY: FILTER BAR ----------- */
    .filterbar{
      position: sticky;
      top: 64px;
      z-index: 110;
      padding: var(--s12) var(--s16);
      background:
        linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.70));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    @media (prefers-color-scheme: dark){
      .filterbar{
        background: linear-gradient(180deg, rgba(38,40,40,.88), rgba(38,40,40,.74));
      }
    }
    .filters{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }

    .seg{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .seg button{
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      box-shadow: var(--shadow3);
    }
    .seg button.active{
      background: rgba(33,128,141,.12);
      border-color: rgba(33,128,141,.45);
      color: var(--primary);
    }
    .seg button:active{ transform: scale(var(--tap)); }

    .search{
      display:flex;
      gap: 10px;
      align-items:center;
      flex: 1;
      min-width: 220px;
      justify-content:flex-end;
    }
    .search input{
      width: min(360px, 100%);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 13px;
      box-shadow: var(--shadow3);
      outline:none;
    }
    .search input:focus{ border-color: rgba(33,128,141,.6); }

    /* ----------- DATE GROUP ----------- */
    .daygroup{
      margin: var(--s16);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .dayhead{
      padding: var(--s12) var(--s16);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(33,128,141,.06), transparent);
    }
    .dayhead .d{
      font-size: 13px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .dayhead .n{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }
    .daybody{ padding: var(--s12) var(--s16) var(--s16); }

    /* ----------- CHECKUPS / REMINDERS ----------- */
    .btn{
      width: 100%;
      padding: 14px 16px;
      border-radius: 14px;
      border: none;
      cursor:pointer;
      color:#fff;
      font-weight: 1000;
      font-size: 15px;
      letter-spacing:.2px;
      background: var(--primary);
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .btn:active{ transform: scale(var(--tap)); background: var(--primary-2); }

    .rem-badge{
      position:absolute;
      top: 4px;
      right: 18px;
      background: var(--orange);
      color: #fff;
      border-radius: 999px;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      font-size: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      line-height: 1;
    }

    .rem-item{
      background: rgba(33,128,141,.08);
      border: 1px solid rgba(33,128,141,.45);
      border-radius: var(--r);
      padding: var(--s12);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: var(--s12);
    }
    .rem-item.past{ opacity: .6; }
    .rem-title{ font-weight: 1000; font-size: 13px; margin-bottom: 4px; }
    .rem-time{ font-size: 12px; color: var(--muted); line-height: 1.35; }
    .trash{
      color: var(--orange);
      font-size: 20px;
      cursor:pointer;
      padding: 6px 8px;
      user-select:none;
    }

    /* ----------- MODALS ----------- */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      z-index: 1000;
      animation: fadeIn .2s;
    }
    .modal.active{ display:flex; align-items:flex-end; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes up{ from{transform: translateY(100%)} to{transform: translateY(0)} }

    .sheet{
      width: 100%;
      max-height: 86vh;
      background: var(--surface);
      border-radius: var(--r2) var(--r2) 0 0;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:auto;
      padding: var(--s18) var(--s18) var(--s24);
      animation: up .28s ease-out;
    }
    .sheet-h{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: var(--s16);
    }
    .sheet-h h3{
      font-size: 17px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .x{
      font-size: 28px;
      line-height:1;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      padding: 4px 8px;
      border-radius: 10px;
    }
    .x:active{ transform: scale(var(--tap)); }

    .group{ margin-bottom: var(--s14); }
    .lab{
      display:block;
      font-size: 13px;
      font-weight: 1000;
      margin-bottom: 8px;
    }
    .input, .sel, .ta{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      font-size: 14px;
      outline:none;
    }
    .ta{ min-height: 84px; resize: vertical; font-family: inherit; }
    .input:focus, .sel:focus, .ta:focus{ border-color: rgba(33,128,141,.6); background: var(--surface); }

    .btnrow{ display:flex; gap: 10px; flex-wrap: wrap; }
    .toggle{
      flex:1;
      min-width: 110px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      cursor:pointer;
      font-weight: 1000;
      font-size: 13px;
      user-select:none;
    }
    .toggle.active{
      background: rgba(33,128,141,.14);
      border-color: rgba(33,128,141,.55);
      color: var(--primary);
    }
    .toggle:active{ transform: scale(var(--tap)); }

    .cta{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border:none;
      cursor:pointer;
      color:#fff;
      font-weight: 1000;
      font-size: 15px;
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .cta:active{ transform: scale(var(--tap)); }

    .timerbox{
      text-align:center;
      padding: var(--s16);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(33,128,141,.10), rgba(33,128,141,.03));
      border: 1px solid rgba(33,128,141,.25);
      margin-bottom: var(--s14);
    }
    .timerbig{
      font-size: 46px;
      font-weight: 1100;
      color: var(--primary);
      font-variant-numeric: tabular-nums;
    }
    .timersub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      line-height: 1.35;
    }

    .empty{
      text-align:center;
      padding: var(--s20);
      color: var(--muted);
      font-size: 13px;
      font-weight: 800;
    }

    /* ----------- BOTTOM NAV ----------- */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index: 200;
      background: linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.92));
      border-top: 1px solid var(--border);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 -10px 20px rgba(0,0,0,.06);
      padding: 10px 8px;
    }
    @media (prefers-color-scheme: dark){
      .nav{
        background: linear-gradient(180deg, rgba(38,40,40,.80), rgba(38,40,40,.92));
        box-shadow: 0 -10px 20px rgba(0,0,0,.30);
      }
    }
    .navrow{
      display:flex;
      justify-content:space-around;
      gap: 8px;
    }
    .navit{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 3px;
      padding: 8px 6px;
      border-radius: 16px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      position:relative;
      font-weight: 900;
    }
    .navit.active{
      color: var(--primary);
      background: rgba(33,128,141,.10);
      border: 1px solid rgba(33,128,141,.25);
    }
    .navico{ font-size: 22px; line-height:1; }
    .navlab{ font-size: 11px; }

    /* ----------- PAGES ----------- */
    .page{ display:none; }
    .page.active{ display:block; }
  </style>
</head>

<body>

  <!-- HOME -->
  <div id="homePage" class="page active">
    <div class="topbar">
      <div class="topbar-row">
        <div class="brand">
          <h1>üë∂ Baby Tracker</h1>
          <small>Brz unos + pregled najva≈ænijih stvari</small>
        </div>
        <div class="pill" id="todayPill">üìÖ Danas: <strong id="todayDate">-</strong></div>
      </div>

      <div class="topbar-stats">
        <div class="pill">üåô Zadnji san: <strong id="lastSleepTime">-</strong></div>
        <div class="pill">üçº Zadnje hranjenje: <strong id="lastFeedingTime">-</strong></div>
      </div>
    </div>

    <div class="wrap">
      <!-- Quick actions -->
      <div class="grid-actions">
        <div class="action a-sleep" onclick="openModal('sleep')">
          <div class="row">
            <div class="ico">üò¥</div>
            <div class="label">San</div>
          </div>
          <div class="sub" id="sleepLastTime">-</div>
          <div class="accent"></div>
        </div>

        <div class="action a-feeding" onclick="openModal('feeding')">
          <div class="row">
            <div class="ico">üçº</div>
            <div class="label">Hranjenje</div>
          </div>
          <div class="sub" id="feedingLastTime">-</div>
          <div class="accent"></div>
        </div>

        <div class="action a-diaper" onclick="openModal('diaper')">
          <div class="row">
            <div class="ico">üë∂</div>
            <div class="label">Pelena</div>
          </div>
          <div class="sub" id="diaperLastTime">-</div>
          <div class="accent"></div>
        </div>

        <div class="action a-bath" onclick="openModal('bath')">
          <div class="row">
            <div class="ico">üõÅ</div>
            <div class="label">Kupanje</div>
          </div>
          <div class="sub" id="bathLastTime">-</div>
          <div class="accent"></div>
        </div>

        <div class="action a-medicine" onclick="openModal('medicine')">
          <div class="row">
            <div class="ico">üíä</div>
            <div class="label">Lijekovi</div>
          </div>
          <div class="sub" id="medicineLastTime">-</div>
          <div class="accent"></div>
        </div>

        <div class="action a-colic" onclick="openModal('colic')">
          <div class="row">
            <div class="ico">üò£</div>
            <div class="label">Grƒçevi</div>
          </div>
          <div class="sub" id="colicLastTime">-</div>
          <div class="accent"></div>
        </div>
      </div>

      <!-- Trenutno / zadnje -->
      <div class="card">
        <div class="card-h">
          <h2>‚ö° Trenutno / zadnje</h2>
          <a class="link" onclick="switchPage('history')">Puna historija</a>
        </div>
        <div class="card-b">
          <div class="status-wrap" id="homeStatusWrap"></div>
        </div>
      </div>

      <!-- Dnevna statistika (sa≈æeto) -->
      <div class="card">
        <div class="card-h">
          <h2>üìå Dana≈°nji sa≈æetak</h2>
          <span class="chip" id="todaySummaryChip">-</span>
        </div>
        <div class="card-b">
          <div class="list" id="todayMiniStats"></div>
        </div>
      </div>

      <!-- Najnovije (samo zadnje 3) -->
      <div class="card">
        <div class="card-h">
          <h2>üïí Najnovije aktivnosti</h2>
          <a class="link" onclick="switchPage('history')">Prika≈æi sve</a>
        </div>
        <div class="card-b">
          <div id="recentActivities" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="historyPage" class="page">
    <div class="topbar">
      <div class="topbar-row">
        <div class="brand">
          <h1>üìä Historija</h1>
          <small>Pregled po danima + brzi filter</small>
        </div>
        <div class="pill">üì¶ Ukupno: <strong id="totalCountPill">0</strong></div>
      </div>
    </div>

    <div class="filterbar">
      <div class="filters">
        <div class="seg" id="historyTypeSeg">
          <button type="button" class="active" data-type="all" onclick="setHistoryType('all')">Sve</button>
          <button type="button" data-type="sleep" onclick="setHistoryType('sleep')">üò¥ San</button>
          <button type="button" data-type="feeding" onclick="setHistoryType('feeding')">üçº Hranjenje</button>
          <button type="button" data-type="diaper" onclick="setHistoryType('diaper')">üë∂ Pelena</button>
          <button type="button" data-type="bath" onclick="setHistoryType('bath')">üõÅ Kupanje</button>
          <button type="button" data-type="medicine" onclick="setHistoryType('medicine')">üíä Lijek</button>
          <button type="button" data-type="colic" onclick="setHistoryType('colic')">üò£ Grƒçevi</button>
        </div>

        <div class="search">
          <input id="historySearch" type="text" placeholder="Pretraga (bilje≈°ke, naziv lijeka...)" oninput="renderHistory()" />
        </div>
      </div>
    </div>

    <div id="historyGroups"></div>
  </div>

  <!-- CHECKUPS -->
  <div id="checkupPage" class="page">
    <div class="topbar">
      <div class="topbar-row">
        <div class="brand">
          <h1>üè• Kontrole</h1>
          <small>Te≈æina, visina, doktor i bilje≈°ke</small>
        </div>
        <div class="pill">üìå Unosa: <strong id="checkupCountPill">0</strong></div>
      </div>
    </div>

    <div class="wrap">
      <button class="btn" onclick="openModal('checkup')">+ Dodaj kontrolu</button>

      <div class="card">
        <div class="card-h">
          <h2>üßæ Spisak kontrola</h2>
        </div>
        <div class="card-b">
          <div id="checkupList" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- REMINDERS -->
  <div id="remindersPage" class="page">
    <div class="topbar">
      <div class="topbar-row">
        <div class="brand">
          <h1>üîî Podsjetnici</h1>
          <small>Obavijest + lista aktivnih</small>
        </div>
        <div class="pill">‚è≥ Aktivnih: <strong id="activeRemCountPill">0</strong></div>
      </div>
    </div>

    <div class="wrap">
      <button class="btn" onclick="openModal('reminder')">+ Dodaj podsjetnik</button>

      <div class="card">
        <div class="card-h">
          <h2>üìå Lista podsjetnika</h2>
        </div>
        <div class="card-b">
          <div id="remindersList" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: SLEEP -->
  <div id="sleepModal" class="modal">
    <div class="sheet">
      <div class="sheet-h">
        <h3>üò¥ San</h3>
        <span class="x" onclick="closeModal('sleep')">&times;</span>
      </div>

      <div id="sleepTimer" class="timerbox" style="display:none;">
        <div class="timerbig" id="sleepTimerText">00:00:00</div>
        <div class="timersub" id="sleepTimerLabel">Vrijeme spavanja</div>
      </div>

      <div class="group" id="sleepStartGroup">
        <label class="lab">Poƒçetak spavanja</label>
        <input type="datetime-local" id="sleepStartTime" class="input">
      </div>

      <div class="group" id="sleepEndGroup" style="display:none;">
        <label class="lab">Buƒëenje</label>
        <input type="datetime-local" id="sleepEndTime" class="input">
      </div>

      <div class="group">
        <label class="lab">Bilje≈°ke</label>
        <textarea id="sleepNotes" class="ta" placeholder="Dodatne bilje≈°ke..."></textarea>
      </div>

      <button class="cta" id="sleepStartBtn" onclick="startSleep()" style="background: var(--purple);">üõèÔ∏è Dijete zaspalo</button>
      <button class="cta" id="sleepWakeBtn" onclick="wakeSleep()" style="display:none; background: var(--orange); margin-top:10px;">‚òÄÔ∏è Dijete se probudilo</button>
    </div>
  </div>

  <!-- MODAL: FEEDING -->
  <div id="feedingModal" class="modal">
    <div class="sheet">
      <div class="sheet-h">
        <h3>üçº Hranjenje</h3>
        <span class="x" onclick="closeModal('feeding')">&times;</span>
      </div>

      <div id="feedingInfo" class="timerbox" style="display:none; border-color: rgba(219,39,119,.35); background: linear-gradient(180deg, rgba(219,39,119,.10), rgba(219,39,119,.03));">
        <div class="timersub" id="feedingInfoLabel">-</div>
      </div>

      <div class="group" id="feedingStartGroup">
        <label class="lab">Poƒçetak hranjenja</label>
        <input type="datetime-local" id="feedingStartTime" class="input">
      </div>

      <div class="group" id="feedingEndGroup" style="display:none;">
        <label class="lab">Kraj hranjenja</label>
        <input type="datetime-local" id="feedingEndTime" class="input">
      </div>

      <div class="group">
        <label class="lab">Dojka</label>
        <div class="btnrow" id="breastButtons">
          <button class="toggle" data-value="left" onclick="selectBreast(this)">Lijeva</button>
          <button class="toggle" data-value="right" onclick="selectBreast(this)">Desna</button>
          <button class="toggle" data-value="both" onclick="selectBreast(this)">Obje</button>
        </div>
      </div>

      <div class="group">
        <label class="lab">Bilje≈°ke (opciono)</label>
        <textarea id="feedingNotes" class="ta" placeholder="Dodatne bilje≈°ke..."></textarea>
      </div>

      <div class="group">
        <label class="lab" style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" id="feedingReminderCheck" style="transform: scale(1.15);">
          Postavi podsjetnik za sljedeƒáe hranjenje
        </label>
      </div>

      <div class="group" id="feedingReminderGroup" style="display:none;">
        <label class="lab">Za koliko sati?</label>
        <div class="btnrow">
          <button type="button" class="toggle" data-value="1.5" onclick="selectFeedingReminderHours(this)">1.5h</button>
          <button type="button" class="toggle" data-value="2" onclick="selectFeedingReminderHours(this)">2h</button>
          <button type="button" class="toggle" data-value="2.5" onclick="selectFeedingReminderHours(this)">2.5h</button>
          <button type="button" class="toggle" data-value="3" onclick="selectFeedingReminderHours(this)">3h</button>
        </div>
      </div>

      <button class="cta" id="feedingStartBtn" onclick="startFeeding()" style="background: var(--pink);">üçº Poƒçinje jesti</button>
      <button class="cta" id="feedingEndBtn" onclick="endFeeding()" style="display:none; background: var(--green); margin-top:10px;">‚úì Zavr≈°io jesti</button>
    </div>
  </div>

  <!-- MODAL: DIAPER -->
  <div id="diaperModal" class="modal">
    <div class="sheet">
      <div class="sheet-h">
        <h3>üë∂ Pelena</h3>
        <span class="x" onclick="closeModal('diaper')">&times;</span>
      </div>

      <div class="group">
        <label class="lab">Vrijeme</label>
        <input type="datetime-local" id="diaperTime" class="input">
      </div>

      <div class="group">
        <label class="lab">Tip</label>
        <div class="btnrow" id="diaperButtons">
          <button class="toggle" data-value="wet" onclick="selectDiaperType(this)">üíß Mokra</button>
          <button class="toggle" data-value="dirty" onclick="selectDiaperType(this)">üí© Prljava</button>
          <button class="toggle" data-value="both" onclick="selectDiaperType(this)">Oboje</button>
        </div>
      </div>

      <div class="group">
        <label class="lab">Bilje≈°ke</label>
        <textarea id="diaperNotes" class="ta" placeholder="Dodatne bilje≈°ke..."></textarea>
      </div>

      <button class="cta" onclick="saveDiaper()" style="background: var(--blue);">Spremi</button>
    </div>
  </div>

  <!-- MODAL: BATH -->
  <div id="bathModal" class="modal">
    <div class="sheet">
      <div class="sheet-h">
        <h3>üõÅ Kupanje</h3>
        <span class="x" onclick="closeModal('bath')">&times;</span>
      </div>

      <div class="group">
        <label class="lab">Vrijeme</label>
        <input type="datetime-local" id="bathTime" class="input">
      </div>

      <div class="group">
        <label class="lab">Temperatura vode</label>
        <input type="text" id="bathTemp" class="input" placeholder="npr. 37¬∞C">
      </div>

      <div class="group">
        <label class="lab">Bilje≈°ke</label>
        <textarea id="bathNotes" class="ta" placeholder="Dodatne bilje≈°ke..."></textarea>
      </div>

      <button class="cta" onclick="saveBath()" style="background: var(--primary);">Spremi</button>
    </div>
  </div>

  <!-- MODAL: MEDICINE -->
  <div id="medicineModal" class="modal">
    <div class="sheet">
      <div class="sheet-h">
        <h3>üíä Lijekovi/Kapi</h3>
        <span class="x" onclick="closeModal('medicine')">&times;</span>
      </div>

      <div class="group">
        <label class="lab">Vrijeme</label>
        <input type="datetime-local" id="medicineTime" class="input">
      </div>

      <div class="group">
        <label class="lab">Naziv lijeka/kapi</label>
        <input type="text" id="medicineName" class="input" placeholder="npr. Espumisan kapi">
      </div>

      <div class="group">
        <label class="lab">Doza</label>
        <input type="text" id="medicineDose" class="input" placeholder="npr. 10 kapi">
      </div>

      <div class="group">
        <label class="lab">Bilje≈°ke</label>
        <textarea id="medicineNotes" class="ta" placeholder="Dodatne bilje≈°ke..."></textarea>
      </div>

      <button class="cta" onclick="saveMedicine()" style="background: var(--orange);">Spremi</button>
    </div>
  </div>

  <!-- MODAL: COLIC -->
  <div id="colicModal" class="modal">
    <div class="sheet">
      <div class="sheet-h">
        <h3>üò£ Grƒçevi</h3>
        <span class="x" onclick="closeModal('colic')">&times;</span>
      </div>

      <div id="colicTimer" class="timerbox" style="display:none; border-color: rgba(249,115,22,.35); background: linear-gradient(180deg, rgba(249,115,22,.10), rgba(249,115,22,.03));">
        <div class="timerbig" id="colicTimerText">00:00:00</div>
        <div class="timersub">Trajanje grƒçeva</div>
      </div>

      <div class="group">
        <label class="lab">Poƒçetak</label>
        <input type="datetime-local" id="colicStartTime" class="input">
      </div>

      <div class="group">
        <label class="lab">Trajanje (minute)</label>
        <input type="number" id="colicDuration" class="input" min="1" placeholder="npr. 30">
      </div>

      <div class="group">
        <label class="lab">Intenzitet</label>
        <div class="btnrow" id="intensityButtons">
          <button class="toggle" data-value="mild" onclick="selectIntensity(this)">Blago</button>
          <button class="toggle" data-value="moderate" onclick="selectIntensity(this)">Umjereno</button>
          <button class="toggle" data-value="severe" onclick="selectIntensity(this)">Jako</button>
        </div>
      </div>

      <div class="group">
        <label class="lab">Bilje≈°ke</label>
        <textarea id="colicNotes" class="ta" placeholder="≈†to je pomoglo..."></textarea>
      </div>

      <button class="cta" id="colicStartBtn" onclick="startColicTimer()" style="background: var(--orange);">Pokreni tajmer</button>
      <button class="cta" id="colicStopBtn" onclick="stopColicTimer()" style="display:none; background: var(--green); margin-top:10px;">Zaustavi tajmer</button>

      <div style="height: 10px;"></div>
      <button class="cta" id="colicSubmitBtn" onclick="saveColic()" style="background: var(--primary);">Spremi</button>
    </div>
  </div>

  <!-- MODAL: CHECKUP -->
  <div id="checkupModal" class="modal">
    <div class="sheet">
      <div class="sheet-h">
        <h3>üè• Kontrola</h3>
        <span class="x" onclick="closeModal('checkup')">&times;</span>
      </div>

      <div class="group">
        <label class="lab">Datum i vrijeme kontrole</label>
        <input type="datetime-local" id="checkupTime" class="input">
      </div>

      <div class="group">
        <label class="lab">Doktor/Klinika</label>
        <input type="text" id="checkupDoctor" class="input" placeholder="npr. Dr. Horvat">
      </div>

      <div class="group">
        <label class="lab">Te≈æina (kg)</label>
        <input type="number" id="checkupWeight" class="input" step="0.1" placeholder="npr. 4.5">
      </div>

      <div class="group">
        <label class="lab">Visina (cm)</label>
        <input type="number" id="checkupHeight" class="input" step="0.5" placeholder="npr. 55">
      </div>

      <div class="group">
        <label class="lab">Bilje≈°ke</label>
        <textarea id="checkupNotes" class="ta" placeholder="Nalazi, preporuke..."></textarea>
      </div>

      <button class="cta" onclick="saveCheckup()" style="background: var(--green);">Spremi</button>
    </div>
  </div>

  <!-- MODAL: REMINDER -->
  <div id="reminderModal" class="modal">
    <div class="sheet">
      <div class="sheet-h">
        <h3>üîî Podsjetnik</h3>
        <span class="x" onclick="closeModal('reminder')">&times;</span>
      </div>

      <div class="group">
        <label class="lab">Naslov</label>
        <input type="text" id="reminderTitle" class="input" placeholder="npr. Vakcinacija">
      </div>

      <div class="group">
        <label class="lab">Datum i vrijeme</label>
        <input type="datetime-local" id="reminderTime" class="input">
      </div>

      <div class="group">
        <label class="lab">Opis</label>
        <textarea id="reminderDesc" class="ta" placeholder="Detalji..."></textarea>
      </div>

      <button class="cta" onclick="saveReminder()" style="background: var(--primary);">Spremi</button>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="nav">
    <div class="navrow">
      <div class="navit active" data-page="home" onclick="switchPage('home')">
        <div class="navico">üè†</div>
        <div class="navlab">Poƒçetna</div>
      </div>

      <div class="navit" data-page="history" onclick="switchPage('history')">
        <div class="navico">üìä</div>
        <div class="navlab">Historija</div>
      </div>

      <div class="navit" data-page="checkup" onclick="switchPage('checkup')">
        <div class="navico">üè•</div>
        <div class="navlab">Kontrole</div>
      </div>

      <div class="navit" data-page="reminders" onclick="switchPage('reminders')">
        <div class="navico" style="position:relative;">
          üîî
          <span id="reminderBadge" class="rem-badge" style="display:none;">0</span>
        </div>
        <div class="navlab">Podsjetnici</div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------------------------------------
    // VA≈ΩNO: localStorage kljuƒçevi su isti -> ni≈°ta se ne bri≈°e
    // -------------------------------------------------------
    const TZ = "Europe/Sarajevo";

    // STORAGE (NE MIJENJATI imena kljuƒçeva)
    let activities = JSON.parse(localStorage.getItem("babyActivities") || "[]");
    let checkups = JSON.parse(localStorage.getItem("babyCheckups") || "[]");
    let reminders = JSON.parse(localStorage.getItem("babyReminders") || "[]");

    let activeSleep = JSON.parse(localStorage.getItem("activeSleep") || "null");       // {startIso, startMs, startDisplay}
    let activeFeeding = JSON.parse(localStorage.getItem("activeFeeding") || "null");   // {startIso, startDisplay, startMs, breast}

    // UI state
    let selectedBreast = null;
    let selectedDiaperType = null;
    let selectedIntensity = null;
    let selectedFeedingReminderHours = null;

    let sleepInterval = null;
    let colicInterval = null;
    let colicStartMs = null;

    // HISTORY filters
    let historyType = "all";

    // -----------------------------
    // POMOƒÜNE FUNKCIJE (vrijeme)
    // -----------------------------
    function getTZParts(date = new Date(), timeZone = TZ) {
      const dtf = new Intl.DateTimeFormat("en-GB", {
        timeZone,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      });
      const parts = dtf.formatToParts(date);
      const map = {};
      parts.forEach(p => { if (p.type !== "literal") map[p.type] = p.value; });
      return map;
    }

    function nowISOInTZ() {
      const p = getTZParts(new Date(), TZ);
      const localLike = new Date(`${p.year}-${p.month}-${p.day}T${p.hour}:${p.minute}:${p.second}`);
      return localLike.toISOString();
    }

    function valueForDatetimeLocalNow() {
      const p = getTZParts(new Date(), TZ);
      return `${p.year}-${p.month}-${p.day}T${p.hour}:${p.minute}`;
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    function hmsFromMs(ms) {
      const total = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(total / 3600);
      const m = Math.floor((total % 3600) / 60);
      const s = total % 60;
      return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatTime(iso) {
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth() + 1).padStart(2,"0");
      const yy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");

      const today = new Date(); today.setHours(0,0,0,0);
      const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
      const d0 = new Date(d); d0.setHours(0,0,0,0);

      if (d0.getTime() === today.getTime()) return `Danas ${hh}:${mi}`;
      if (d0.getTime() === yesterday.getTime()) return `Juƒçer ${hh}:${mi}`;
      return `${dd}.${mm}.${yy} ${hh}:${mi}`;
    }

    function formatDateHeading(dateObj){
      const dd = String(dateObj.getDate()).padStart(2,"0");
      const mm = String(dateObj.getMonth()+1).padStart(2,"0");
      const yy = dateObj.getFullYear();
      const today = new Date(); today.setHours(0,0,0,0);
      const y = new Date(today); y.setDate(y.getDate()-1);

      const d0 = new Date(dateObj); d0.setHours(0,0,0,0);
      if (d0.getTime() === today.getTime()) return `Danas (${dd}.${mm}.${yy})`;
      if (d0.getTime() === y.getTime()) return `Juƒçer (${dd}.${mm}.${yy})`;
      return `${dd}.${mm}.${yy}`;
    }

    function formatTimeAgo(iso) {
      const now = Date.now();
      const then = new Date(iso).getTime();
      const diff = now - then;

      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (minutes < 1) return "upravo";
      if (minutes < 60) return `Prije ${minutes} min`;
      if (hours < 24) return `Prije ${hours}h`;
      return `Prije ${days} dana`;
    }

    function startOfTodayLocal(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d;
    }

    function normalizeActivity(a){
      // sigurnost: ako neko staro nije imalo timestamp, dodaj ga (ne bri≈°e ni≈°ta)
      if (!a.timestamp) a.timestamp = new Date(a.time || Date.now()).getTime();
      return a;
    }

    // -------------------------------------------------------
    // MODALI (otvaranje / zatvaranje)
    // -------------------------------------------------------
    function openModal(type) {
      const modal = document.getElementById(type + "Modal");
      if (!modal) return;
      modal.classList.add("active");

      const map = {
        sleep: "sleepStartTime",
        feeding: "feedingStartTime",
        diaper: "diaperTime",
        bath: "bathTime",
        medicine: "medicineTime",
        colic: "colicStartTime",
        checkup: "checkupTime",
        reminder: "reminderTime"
      };

      if (map[type]) {
        const el = document.getElementById(map[type]);
        if (el && !el.value) el.value = valueForDatetimeLocalNow();
      }

      if (type === "sleep") {
        if (activeSleep) showActiveSleepUI();
        else resetSleepUI(false);
      }

      if (type === "feeding") {
        if (activeFeeding) showActiveFeedingUI();
        else resetFeedingUI(false);
      }

      if (type === "colic") {
        document.getElementById("colicTimer").style.display = "none";
        document.getElementById("colicStartBtn").style.display = "block";
        document.getElementById("colicStopBtn").style.display = "none";
      }
    }

    function closeModal(type) {
      const modal = document.getElementById(type + "Modal");
      if (!modal) return;
      modal.classList.remove("active");

      if (type === "sleep") {
        if (sleepInterval) { clearInterval(sleepInterval); sleepInterval = null; }
        document.getElementById("sleepNotes").value = "";
        if (activeSleep) showActiveSleepUI(); else resetSleepUI(true);
      }

      if (type === "feeding") {
        document.getElementById("feedingNotes").value = "";
        document.getElementById("feedingEndTime").value = "";
        if (activeFeeding) showActiveFeedingUI(); else resetFeedingUI(true);
      }

      if (type === "diaper") {
        document.getElementById("diaperNotes").value = "";
        document.querySelectorAll("#diaperButtons .toggle").forEach(b => b.classList.remove("active"));
        selectedDiaperType = null;
      }

      if (type === "bath") {
        document.getElementById("bathTemp").value = "";
        document.getElementById("bathNotes").value = "";
      }

      if (type === "medicine") {
        document.getElementById("medicineName").value = "";
        document.getElementById("medicineDose").value = "";
        document.getElementById("medicineNotes").value = "";
      }

      if (type === "colic") {
        if (colicInterval) { clearInterval(colicInterval); colicInterval = null; }
        colicStartMs = null;
        document.getElementById("colicDuration").value = "";
        document.getElementById("colicNotes").value = "";
        document.querySelectorAll("#intensityButtons .toggle").forEach(b => b.classList.remove("active"));
        selectedIntensity = null;
        document.getElementById("colicTimer").style.display = "none";
        document.getElementById("colicStartBtn").style.display = "block";
        document.getElementById("colicStopBtn").style.display = "none";
        document.getElementById("colicTimerText").textContent = "00:00:00";
      }

      if (type === "checkup") {
        document.getElementById("checkupDoctor").value = "";
        document.getElementById("checkupWeight").value = "";
        document.getElementById("checkupHeight").value = "";
        document.getElementById("checkupNotes").value = "";
      }

      if (type === "reminder") {
        document.getElementById("reminderTitle").value = "";
        document.getElementById("reminderDesc").value = "";
      }
    }

    // zatvori klikom izvan
    document.querySelectorAll(".modal").forEach(modal => {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          const type = modal.id.replace("Modal", "");
          closeModal(type);
        }
      });
    });

    // -------------------------------------------------------
    // SLEEP
    // -------------------------------------------------------
    function resetSleepUI(fullReset) {
      document.getElementById("sleepTimer").style.display = "none";
      document.getElementById("sleepStartBtn").style.display = "block";
      document.getElementById("sleepWakeBtn").style.display = "none";
      document.getElementById("sleepStartGroup").style.display = "block";
      document.getElementById("sleepEndGroup").style.display = "none";
      document.getElementById("sleepTimerText").textContent = "00:00:00";
      document.getElementById("sleepTimerLabel").textContent = "Vrijeme spavanja";
      if (fullReset) {
        document.getElementById("sleepStartTime").value = "";
        document.getElementById("sleepEndTime").value = "";
      }
    }

    function showActiveSleepUI() {
      resetSleepUI(false);
      document.getElementById("sleepTimer").style.display = "block";
      document.getElementById("sleepStartBtn").style.display = "none";
      document.getElementById("sleepWakeBtn").style.display = "block";
      document.getElementById("sleepStartGroup").style.display = "none";
      document.getElementById("sleepEndGroup").style.display = "none";

      if (sleepInterval) { clearInterval(sleepInterval); sleepInterval = null; }

      sleepInterval = setInterval(() => {
        const elapsed = Date.now() - activeSleep.startMs;
        document.getElementById("sleepTimerText").textContent = hmsFromMs(elapsed);
        document.getElementById("sleepTimerLabel").textContent = `Poƒçeo spavati u ${activeSleep.startDisplay}`;
      }, 500);

      const elapsed = Date.now() - activeSleep.startMs;
      document.getElementById("sleepTimerText").textContent = hmsFromMs(elapsed);
      document.getElementById("sleepTimerLabel").textContent = `Poƒçeo spavati u ${activeSleep.startDisplay}`;
    }

    function startSleep() {
      if (activeSleep) return;

      const manual = document.getElementById("sleepStartTime").value;
      let startDate = manual ? new Date(manual) : new Date(nowISOInTZ());

      if (startDate.getTime() > Date.now() + 60000) {
        alert("Poƒçetak spavanja ne mo≈æe biti u buduƒánosti.");
        return;
      }

      const startIso = startDate.toISOString();
      const startDisplay = startDate.toLocaleString("hr-HR", { hour: "2-digit", minute: "2-digit" });

      activeSleep = { startIso, startMs: startDate.getTime(), startDisplay };
      localStorage.setItem("activeSleep", JSON.stringify(activeSleep));

      updateSleepQuickButton(true);
      closeModal("sleep");
      ensureHomeIntervals();
      updateDisplay();
    }

    function wakeSleep() {
      if (!activeSleep) return;

      const endDate = new Date(nowISOInTZ());
      const durationHours = (endDate.getTime() - activeSleep.startMs) / 3600000;

      if (durationHours <= 0) {
        alert("Gre≈°ka u vremenima!");
        return;
      }

      const notes = document.getElementById("sleepNotes").value || "";
      const endDisplay = endDate.toLocaleString("hr-HR", { hour: "2-digit", minute: "2-digit" });

      activities.push(normalizeActivity({
        type: "sleep",
        time: activeSleep.startIso,
        endTime: endDate.toISOString(),
        duration: durationHours,
        notes,
        startTimeDisplay: activeSleep.startDisplay,
        endTimeDisplay: endDisplay,
        timestamp: Date.now()
      }));

      activeSleep = null;
      localStorage.removeItem("activeSleep");
      if (sleepInterval) { clearInterval(sleepInterval); sleepInterval = null; }

      updateSleepQuickButton(false);
      saveAndRefresh();
      closeModal("sleep");
    }

    function updateSleepQuickButton(isSleeping) {
      const el = document.getElementById("sleepLastTime");
      if (!el) return;

      if (isSleeping && activeSleep) {
        const elapsed = Date.now() - activeSleep.startMs;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        el.textContent = `üõèÔ∏è Spava ${hours}h ${minutes}min`;
      }
    }

    // -------------------------------------------------------
    // FEEDING
    // -------------------------------------------------------
    function resetFeedingUI(fullReset) {
      document.getElementById("feedingInfo").style.display = "none";
      document.getElementById("feedingStartBtn").style.display = "block";
      document.getElementById("feedingEndBtn").style.display = "none";
      document.getElementById("feedingStartGroup").style.display = "block";
      document.getElementById("feedingEndGroup").style.display = "none";

      document.querySelectorAll("#breastButtons .toggle").forEach(b => b.classList.remove("active"));
      selectedBreast = null;

      const chk = document.getElementById("feedingReminderCheck");
      chk.checked = false;
      document.getElementById("feedingReminderGroup").style.display = "none";
      selectedFeedingReminderHours = null;
      document.querySelectorAll("#feedingReminderGroup .toggle").forEach(b => b.classList.remove("active"));

      if (fullReset) {
        document.getElementById("feedingStartTime").value = "";
        document.getElementById("feedingEndTime").value = "";
      }
    }

    function showActiveFeedingUI() {
      resetFeedingUI(false);

      selectedBreast = activeFeeding.breast;
      document.querySelectorAll("#breastButtons .toggle").forEach(btn => {
        if (btn.dataset.value === activeFeeding.breast) btn.classList.add("active");
      });

      document.getElementById("feedingStartBtn").style.display = "none";
      document.getElementById("feedingEndBtn").style.display = "block";
      document.getElementById("feedingStartGroup").style.display = "none";
      document.getElementById("feedingEndGroup").style.display = "block";
      document.getElementById("feedingEndTime").value = valueForDatetimeLocalNow();

      document.getElementById("feedingInfo").style.display = "block";
      document.getElementById("feedingInfoLabel").textContent = `Poƒçeo jesti u ${activeFeeding.startDisplay}`;
    }

    function selectBreast(btn) {
      document.querySelectorAll("#breastButtons .toggle").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedBreast = btn.dataset.value;
    }

    function selectFeedingReminderHours(btn) {
      document.querySelectorAll("#feedingReminderGroup .toggle").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedFeedingReminderHours = parseFloat(btn.dataset.value);
    }

    document.getElementById("feedingReminderCheck").addEventListener("change", (e) => {
      const group = document.getElementById("feedingReminderGroup");
      if (e.target.checked) group.style.display = "block";
      else {
        group.style.display = "none";
        selectedFeedingReminderHours = null;
        document.querySelectorAll("#feedingReminderGroup .toggle").forEach(b => b.classList.remove("active"));
      }
    });

    function startFeeding() {
      if (activeFeeding) return;
      if (!selectedBreast) {
        alert("Molimo odaberite dojku!");
        return;
      }

      const manual = document.getElementById("feedingStartTime").value;
      const startDate = manual ? new Date(manual) : new Date(nowISOInTZ());

      if (startDate.getTime() > Date.now() + 60000) {
        alert("Poƒçetak hranjenja ne mo≈æe biti u buduƒánosti.");
        return;
      }

      const startIso = startDate.toISOString();
      const startDisplay = startDate.toLocaleString("hr-HR", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });

      activeFeeding = {
        startIso,
        startMs: startDate.getTime(),
        startDisplay,
        breast: selectedBreast
      };
      localStorage.setItem("activeFeeding", JSON.stringify(activeFeeding));

      updateFeedingQuickButton(true);
      closeModal("feeding");
      ensureHomeIntervals();
      updateDisplay();
    }

    function endFeeding() {
      if (!activeFeeding) return;

      const endVal = document.getElementById("feedingEndTime").value;
      const endDate = endVal ? new Date(endVal) : new Date(nowISOInTZ());

      const durationMin = Math.round((endDate.getTime() - activeFeeding.startMs) / 60000);
      if (durationMin <= 0) { alert("Gre≈°ka u vremenima!"); return; }

      const notes = document.getElementById("feedingNotes").value || "";
      const endDisplay = endDate.toLocaleString("hr-HR", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });

      activities.push(normalizeActivity({
        type: "feeding",
        time: activeFeeding.startIso,
        endTime: endDate.toISOString(),
        breast: activeFeeding.breast,
        duration: durationMin,
        notes,
        startTimeDisplay: activeFeeding.startDisplay,
        endTimeDisplay: endDisplay,
        timestamp: Date.now()
      }));

      // Podsjetnik za hranjenje (ako je izabran)
      const reminderCheck = document.getElementById("feedingReminderCheck").checked;
      if (reminderCheck && selectedFeedingReminderHours) {
        const rt = new Date(endDate.getTime() + selectedFeedingReminderHours * 3600000);
        reminders.push({
          title: "Vrijeme za hranjenje",
          time: rt.toISOString(),
          description: `Pro≈°lo je ${selectedFeedingReminderHours}h od posljednjeg hranjenja`,
          timestamp: Date.now(),
          notified: false
        });
        localStorage.setItem("babyReminders", JSON.stringify(reminders));
      }

      activeFeeding = null;
      localStorage.removeItem("activeFeeding");

      updateFeedingQuickButton(false);
      saveAndRefresh();
      closeModal("feeding");
      updateReminders();
    }

    function updateFeedingQuickButton(isFeeding) {
      const el = document.getElementById("feedingLastTime");
      if (!el) return;

      if (isFeeding && activeFeeding) {
        const breastText = activeFeeding.breast === "left" ? "lijeva" : activeFeeding.breast === "right" ? "desna" : "obje";
        el.textContent = `üçº Jede (${breastText}) od ${activeFeeding.startDisplay}`;
      }
    }

    // -------------------------------------------------------
    // DIAPER / BATH / MEDICINE / COLIC
    // -------------------------------------------------------
    function selectDiaperType(btn) {
      document.querySelectorAll("#diaperButtons .toggle").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedDiaperType = btn.dataset.value;
    }

    function saveDiaper() {
      const val = document.getElementById("diaperTime").value;
      if (!val || !selectedDiaperType) {
        alert("Molimo unesite vrijeme i odaberite tip!");
        return;
      }
      const notes = document.getElementById("diaperNotes").value || "";
      activities.push(normalizeActivity({
        type: "diaper",
        time: new Date(val).toISOString(),
        diaperType: selectedDiaperType,
        notes,
        timestamp: Date.now()
      }));
      saveAndRefresh();
      closeModal("diaper");
    }

    function saveBath() {
      const val = document.getElementById("bathTime").value;
      if (!val) { alert("Molimo unesite vrijeme!"); return; }
      const temp = document.getElementById("bathTemp").value || "";
      const notes = document.getElementById("bathNotes").value || "";
      activities.push(normalizeActivity({
        type: "bath",
        time: new Date(val).toISOString(),
        temperature: temp,
        notes,
        timestamp: Date.now()
      }));
      saveAndRefresh();
      closeModal("bath");
    }

    function saveMedicine() {
      const val = document.getElementById("medicineTime").value;
      const name = document.getElementById("medicineName").value.trim();
      if (!val || !name) { alert("Molimo unesite vrijeme i naziv!"); return; }
      const dose = document.getElementById("medicineDose").value || "";
      const notes = document.getElementById("medicineNotes").value || "";
      activities.push(normalizeActivity({
        type: "medicine",
        time: new Date(val).toISOString(),
        name,
        dose,
        notes,
        timestamp: Date.now()
      }));
      saveAndRefresh();
      closeModal("medicine");
    }

    function selectIntensity(btn) {
      document.querySelectorAll("#intensityButtons .toggle").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selectedIntensity = btn.dataset.value;
    }

    function startColicTimer() {
      if (!selectedIntensity) {
        alert("Molimo odaberite intenzitet prije pokretanja tajmera!");
        return;
      }
      colicStartMs = Date.now();
      document.getElementById("colicTimer").style.display = "block";
      document.getElementById("colicStartBtn").style.display = "none";
      document.getElementById("colicStopBtn").style.display = "block";

      if (colicInterval) { clearInterval(colicInterval); colicInterval = null; }
      colicInterval = setInterval(() => {
        document.getElementById("colicTimerText").textContent = hmsFromMs(Date.now() - colicStartMs);
      }, 500);
    }

    function stopColicTimer() {
      if (!colicStartMs) return;
      if (colicInterval) { clearInterval(colicInterval); colicInterval = null; }
      const minutes = Math.max(1, Math.round((Date.now() - colicStartMs) / 60000));
      document.getElementById("colicDuration").value = minutes;
      document.getElementById("colicTimer").style.display = "none";
      document.getElementById("colicStartBtn").style.display = "block";
      document.getElementById("colicStopBtn").style.display = "none";
      document.getElementById("colicTimerText").textContent = "00:00:00";
      colicStartMs = null;
    }

    function saveColic() {
      const startVal = document.getElementById("colicStartTime").value;
      const durVal = document.getElementById("colicDuration").value;
      if (!startVal || !durVal || !selectedIntensity) {
        alert("Molimo popunite sva obavezna polja!");
        return;
      }
      const notes = document.getElementById("colicNotes").value || "";
      activities.push(normalizeActivity({
        type: "colic",
        time: new Date(startVal).toISOString(),
        duration: parseInt(durVal, 10),
        intensity: selectedIntensity,
        notes,
        timestamp: Date.now()
      }));
      saveAndRefresh();
      closeModal("colic");
    }

    // -------------------------------------------------------
    // CHECKUP / REMINDER
    // -------------------------------------------------------
    function saveCheckup() {
      const val = document.getElementById("checkupTime").value;
      if (!val) { alert("Molimo unesite datum kontrole!"); return; }

      const doctor = document.getElementById("checkupDoctor").value || "";
      const weight = document.getElementById("checkupWeight").value;
      const height = document.getElementById("checkupHeight").value;
      const notes = document.getElementById("checkupNotes").value || "";

      checkups.push({
        time: new Date(val).toISOString(),
        doctor,
        weight: weight ? Number(weight) : null,
        height: height ? Number(height) : null,
        notes,
        timestamp: Date.now()
      });

      localStorage.setItem("babyCheckups", JSON.stringify(checkups));
      updateCheckups();
      closeModal("checkup");
    }

    function saveReminder() {
      const title = document.getElementById("reminderTitle").value.trim();
      const val = document.getElementById("reminderTime").value;
      if (!title || !val) { alert("Molimo unesite naslov i vrijeme!"); return; }
      const desc = document.getElementById("reminderDesc").value || "";

      reminders.push({
        title,
        time: new Date(val).toISOString(),
        description: desc,
        timestamp: Date.now(),
        notified: false
      });

      localStorage.setItem("babyReminders", JSON.stringify(reminders));
      updateReminders();
      closeModal("reminder");
    }

    function deleteReminder(index) {
      if (!confirm("Obrisati podsjetnik?")) return;
      reminders.splice(index, 1);
      localStorage.setItem("babyReminders", JSON.stringify(reminders));
      updateReminders();
    }

    // -------------------------------------------------------
    // UI: ICONS / TITLE / DETAILS
    // -------------------------------------------------------
    function getActivityMeta(activity) {
      const map = {
        sleep:   { emoji: "üò¥", bg: "rgba(168,85,247,0.14)", color: "var(--purple)", title: "San" },
        feeding: { emoji: "üçº", bg: "rgba(219,39,119,0.14)", color: "var(--pink)", title: "Hranjenje" },
        diaper:  { emoji: "üë∂", bg: "rgba(59,130,246,0.14)", color: "var(--blue)", title: "Pelena" },
        bath:    { emoji: "üõÅ", bg: "rgba(33,128,141,0.14)", color: "var(--primary)", title: "Kupanje" },
        medicine:{ emoji: "üíä", bg: "rgba(249,115,22,0.14)", color: "var(--orange)", title: "Lijek" },
        colic:   { emoji: "üò£", bg: "rgba(249,115,22,0.14)", color: "var(--orange)", title: "Grƒçevi" }
      };
      return map[activity.type] || map.sleep;
    }

    function getActivityDetails(activity) {
      switch (activity.type) {
        case "sleep":
          return `${(activity.duration || 0).toFixed(1)}h (${activity.startTimeDisplay || "-"} - ${activity.endTimeDisplay || "-"})` +
            (activity.notes ? ` ‚Ä¢ ${escapeHtml(activity.notes)}` : "");
        case "feeding": {
          const breastText = activity.breast === "left" ? "lijeva" : activity.breast === "right" ? "desna" : "obje";
          return `${activity.duration || 0} min (${breastText})` + (activity.notes ? ` ‚Ä¢ ${escapeHtml(activity.notes)}` : "");
        }
        case "diaper": {
          const typeText = activity.diaperType === "wet" ? "Mokra" : activity.diaperType === "dirty" ? "Prljava" : "Oboje";
          return `${typeText}` + (activity.notes ? ` ‚Ä¢ ${escapeHtml(activity.notes)}` : "");
        }
        case "bath":
          return (activity.temperature ? `Temp: ${escapeHtml(activity.temperature)}` : "Kupanje") + (activity.notes ? ` ‚Ä¢ ${escapeHtml(activity.notes)}` : "");
        case "medicine":
          return `${escapeHtml(activity.name || "")}${activity.dose ? ` - ${escapeHtml(activity.dose)}` : ""}` + (activity.notes ? ` ‚Ä¢ ${escapeHtml(activity.notes)}` : "");
        case "colic": {
          const intensityText = activity.intensity === "mild" ? "Blago" : activity.intensity === "moderate" ? "Umjereno" : "Jako";
          return `${activity.duration || 0} min (${intensityText})` + (activity.notes ? ` ‚Ä¢ ${escapeHtml(activity.notes)}` : "");
        }
        default:
          return "";
      }
    }

    // -------------------------------------------------------
    // HOME: status (trenutno + zadnje po tipu)
    // -------------------------------------------------------
    function getLastByType(type){
      const arr = activities
        .map(normalizeActivity)
        .filter(a => a.type === type)
        .sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
      return arr[0] || null;
    }

    function renderHomeStatus(){
      const wrap = document.getElementById("homeStatusWrap");

      const blocks = [];

      // 1) Aktivno spavanje / hranjenje (ako postoji)
      if (activeSleep) {
        const elapsed = Date.now() - activeSleep.startMs;
        blocks.push({
          icon: "üò¥",
          title: "San je u toku",
          detail: `Poƒçeo u ${activeSleep.startDisplay} ‚Ä¢ traje ${hmsFromMs(elapsed)}`,
          chip: { text: "U toku", cls: "chip live purple" }
        });
      } else {
        const last = getLastByType("sleep");
        blocks.push({
          icon: "üò¥",
          title: "Zadnji san",
          detail: last ? `${formatTime(last.time)} ‚Ä¢ ${getActivityDetails(last)}` : "Nema unosa",
          chip: last ? { text: formatTimeAgo(last.time), cls: "chip" } : { text: "-", cls: "chip" }
        });
      }

      if (activeFeeding) {
        const breastText = activeFeeding.breast === "left" ? "lijeva" : activeFeeding.breast === "right" ? "desna" : "obje";
        blocks.push({
          icon: "üçº",
          title: "Hranjenje je u toku",
          detail: `Poƒçelo u ${activeFeeding.startDisplay} ‚Ä¢ dojka: ${breastText}`,
          chip: { text: "U toku", cls: "chip live pink" }
        });
      } else {
        const last = getLastByType("feeding");
        blocks.push({
          icon: "üçº",
          title: "Zadnje hranjenje",
          detail: last ? `${formatTime(last.time)} ‚Ä¢ ${getActivityDetails(last)}` : "Nema unosa",
          chip: last ? { text: formatTimeAgo(last.time), cls: "chip" } : { text: "-", cls: "chip" }
        });
      }

      // 2) Zadnje pelena/kupanje/lijek/grƒçevi (kratko)
      const types = ["diaper","bath","medicine","colic"];
      const tNames = { diaper:"Pelena", bath:"Kupanje", medicine:"Lijek", colic:"Grƒçevi" };
      const tIcons = { diaper:"üë∂", bath:"üõÅ", medicine:"üíä", colic:"üò£" };

      types.forEach(t => {
        const last = getLastByType(t);
        blocks.push({
          icon: tIcons[t],
          title: `Zadnje: ${tNames[t]}`,
          detail: last ? `${formatTime(last.time)} ‚Ä¢ ${getActivityDetails(last)}` : "Nema unosa",
          chip: last ? { text: formatTimeAgo(last.time), cls: "chip" } : { text: "-", cls: "chip" }
        });
      });

      wrap.innerHTML = blocks.map(b => `
        <div class="status">
          <div class="big">${b.icon}</div>
          <div class="txt">
            <div class="t">${escapeHtml(b.title)} <span class="${b.chip.cls}">${escapeHtml(b.chip.text)}</span></div>
            <div class="d">${b.detail}</div>
          </div>
        </div>
      `).join("");
    }

    // -------------------------------------------------------
    // HOME: recent (zadnje 3)
    // -------------------------------------------------------
    function updateRecentActivities() {
      const container = document.getElementById("recentActivities");
      const sorted = [...activities].map(normalizeActivity).sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
      const recent = sorted.slice(0, 3);

      if (!recent.length) {
        container.innerHTML = '<div class="empty">Nema aktivnosti</div>';
        return;
      }

      container.innerHTML = recent.map(a => {
        const m = getActivityMeta(a);
        const details = getActivityDetails(a);
        const time = formatTime(a.time);
        return `
          <div class="item">
            <div class="ic" style="background:${m.bg}; color:${m.color};">${m.emoji}</div>
            <div class="c">
              <div class="tt">${m.title}</div>
              <div class="dd">${details}</div>
            </div>
            <div class="time">${time}</div>
          </div>
        `;
      }).join("");
    }

    // -------------------------------------------------------
    // HOME: stats (sa≈æeto)
    // -------------------------------------------------------
    function updateTodayStatsMini(){
      const start = startOfTodayLocal();
      const todayActs = activities.map(normalizeActivity).filter(a => new Date(a.time) >= start);

      const sleepCount = todayActs.filter(a => a.type === "sleep").length;
      const feedingCount = todayActs.filter(a => a.type === "feeding").length;
      const diaperCount = todayActs.filter(a => a.type === "diaper").length;

      const totalSleep = todayActs.filter(a => a.type === "sleep")
        .reduce((sum,a) => sum + (Number(a.duration)||0), 0);

      const chip = document.getElementById("todaySummaryChip");
      chip.textContent = `${sleepCount} san ‚Ä¢ ${feedingCount} hranjenja ‚Ä¢ ${diaperCount} pelena`;

      const box = document.getElementById("todayMiniStats");
      const items = [
        { emoji:"üò¥", title:"Ukupno spavanja", detail:`${totalSleep.toFixed(1)}h`, color:"var(--purple)", bg:"rgba(168,85,247,0.14)" },
        { emoji:"üçº", title:"Hranjenja danas", detail:`${feedingCount}`, color:"var(--pink)", bg:"rgba(219,39,119,0.14)" },
        { emoji:"üë∂", title:"Pelene danas", detail:`${diaperCount}`, color:"var(--blue)", bg:"rgba(59,130,246,0.14)" },
      ];

      box.innerHTML = items.map(it => `
        <div class="item">
          <div class="ic" style="background:${it.bg}; color:${it.color};">${it.emoji}</div>
          <div class="c">
            <div class="tt">${it.title}</div>
            <div class="dd">${it.detail}</div>
          </div>
          <div class="time">danas</div>
        </div>
      `).join("");
    }

    // -------------------------------------------------------
    // LAST TIMES (header + quick)
    // -------------------------------------------------------
    function updateLastTimes() {
      const lastSleep = getLastByType("sleep");
      const lastFeeding = getLastByType("feeding");

      document.getElementById("lastSleepTime").textContent = lastSleep ? formatTimeAgo(lastSleep.time) : "-";
      document.getElementById("lastFeedingTime").textContent = lastFeeding ? formatTimeAgo(lastFeeding.time) : "-";

      if (!activeSleep) document.getElementById("sleepLastTime").textContent = lastSleep ? formatTimeAgo(lastSleep.time) : "-";
      if (!activeFeeding) document.getElementById("feedingLastTime").textContent = lastFeeding ? formatTimeAgo(lastFeeding.time) : "-";

      const lastDiaper = getLastByType("diaper");
      document.getElementById("diaperLastTime").textContent = lastDiaper ? formatTimeAgo(lastDiaper.time) : "-";

      const lastBath = getLastByType("bath");
      document.getElementById("bathLastTime").textContent = lastBath ? formatTimeAgo(lastBath.time) : "-";

      const lastMedicine = getLastByType("medicine");
      document.getElementById("medicineLastTime").textContent = lastMedicine ? formatTimeAgo(lastMedicine.time) : "-";

      const lastColic = getLastByType("colic");
      document.getElementById("colicLastTime").textContent = lastColic ? formatTimeAgo(lastColic.time) : "-";

      if (activeSleep) updateSleepQuickButton(true);
      if (activeFeeding) updateFeedingQuickButton(true);
    }

    // -------------------------------------------------------
    // HISTORY: filter + grupisanje po danu
    // -------------------------------------------------------
    function setHistoryType(type){
      historyType = type;
      document.querySelectorAll("#historyTypeSeg button").forEach(b => {
        b.classList.toggle("active", b.dataset.type === type);
      });
      renderHistory();
    }

    function activityMatchesSearch(a, q){
      if (!q) return true;
      q = q.toLowerCase();

      const parts = [];
      parts.push(a.type || "");
      parts.push(a.notes || "");
      parts.push(a.name || "");
      parts.push(a.dose || "");
      parts.push(a.temperature || "");
      parts.push(a.diaperType || "");
      parts.push(a.intensity || "");
      parts.push(a.breast || "");
      parts.push(a.startTimeDisplay || "");
      parts.push(a.endTimeDisplay || "");
      parts.push(String(a.duration || ""));
      parts.push(String(a.time || ""));
      return parts.join(" ").toLowerCase().includes(q);
    }

    function groupByDay(list){
      const map = new Map(); // key yyyy-mm-dd -> array
      list.forEach(a => {
        const d = new Date(a.time);
        const key = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(a);
      });
      // sortiraj dane desc
      const keys = Array.from(map.keys()).sort((k1,k2) => (k1<k2?1:-1));
      return keys.map(k => {
        const arr = map.get(k).sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
        const dateObj = new Date(arr[0].time);
        return { key:k, dateObj, items: arr };
      });
    }

    function renderHistory(){
      const q = (document.getElementById("historySearch").value || "").trim();
      const base = [...activities].map(normalizeActivity).sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));

      const filtered = base.filter(a => {
        if (historyType !== "all" && a.type !== historyType) return false;
        if (!activityMatchesSearch(a, q)) return false;
        return true;
      });

      document.getElementById("totalCountPill").textContent = String(filtered.length);

      const container = document.getElementById("historyGroups");
      if (!filtered.length){
        container.innerHTML = `<div class="empty" style="padding:24px;">Nema rezultata za odabrani filter/pretragu.</div>`;
        return;
      }

      const groups = groupByDay(filtered);

      container.innerHTML = groups.map(g => {
        const head = formatDateHeading(g.dateObj);
        const count = g.items.length;

        const body = g.items.map(a => {
          const m = getActivityMeta(a);
          const details = getActivityDetails(a);
          const time = formatTime(a.time);
          return `
            <div class="item">
              <div class="ic" style="background:${m.bg}; color:${m.color};">${m.emoji}</div>
              <div class="c">
                <div class="tt">${m.title}</div>
                <div class="dd">${details}</div>
              </div>
              <div class="time">${time}</div>
            </div>
          `;
        }).join("");

        return `
          <div class="daygroup">
            <div class="dayhead">
              <div class="d">${escapeHtml(head)}</div>
              <div class="n">${count} unosa</div>
            </div>
            <div class="daybody">
              <div class="list">${body}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    // -------------------------------------------------------
    // CHECKUPS UI
    // -------------------------------------------------------
    function updateCheckups() {
      const container = document.getElementById("checkupList");
      const sorted = [...checkups].sort((a,b) => new Date(b.time) - new Date(a.time));
      document.getElementById("checkupCountPill").textContent = String(sorted.length);

      if (!sorted.length) {
        container.innerHTML = '<div class="empty">Nema unesenih kontrola</div>';
        return;
      }

      container.innerHTML = sorted.map(ch => {
        const time = formatTime(ch.time);
        const details = [];
        if (ch.weight) details.push(`${ch.weight} kg`);
        if (ch.height) details.push(`${ch.height} cm`);
        const notes = ch.notes ? ` ‚Ä¢ ${escapeHtml(ch.notes)}` : "";

        return `
          <div class="item">
            <div class="ic" style="background: rgba(34,197,94,0.14); color: var(--green);">üè•</div>
            <div class="c">
              <div class="tt">${escapeHtml(ch.doctor || "Kontrola")}</div>
              <div class="dd">${details.join(" ‚Ä¢ ") || "‚Äî"}${notes}</div>
            </div>
            <div class="time">${time}</div>
          </div>
        `;
      }).join("");
    }

    // -------------------------------------------------------
    // REMINDERS UI + notifikacije
    // -------------------------------------------------------
    function updateReminders() {
      const container = document.getElementById("remindersList");
      const now = new Date();
      const sorted = [...reminders].sort((a,b) => new Date(a.time) - new Date(b.time));

      const activeCount = sorted.filter(r => new Date(r.time) > now).length;
      document.getElementById("activeRemCountPill").textContent = String(activeCount);

      const badge = document.getElementById("reminderBadge");
      if (activeCount > 0) {
        badge.textContent = activeCount;
        badge.style.display = "flex";
      } else {
        badge.style.display = "none";
      }

      if (!sorted.length) {
        container.innerHTML = '<div class="empty">Nema podsjetnika</div>';
        return;
      }

      container.innerHTML = sorted.map((r, idx) => {
        const t = formatTime(r.time);
        const isPast = new Date(r.time) < now;
        return `
          <div class="rem-item ${isPast ? "past" : ""}">
            <div style="flex:1; min-width:0;">
              <div class="rem-title">${escapeHtml(r.title)}</div>
              <div class="rem-time">${t}</div>
              ${r.description ? `<div class="rem-time" style="margin-top:6px;">${escapeHtml(r.description)}</div>` : ""}
            </div>
            <div class="trash" onclick="deleteReminder(${idx})">üóëÔ∏è</div>
          </div>
        `;
      }).join("");
    }

    function requestNotificationPermission() {
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }
    }

    function showReminderNotification(reminder) {
      const msg = `${reminder.title}\n${reminder.description || ""}`.trim();

      if (!("Notification" in window)) {
        alert("Podsjetnik:\n\n" + msg);
        return;
      }

      if (Notification.permission === "granted") {
        const n = new Notification("Baby Tracker", { body: msg });
        n.onclick = () => { window.focus(); switchPage("reminders"); n.close(); };
        return;
      }

      alert("Podsjetnik:\n\n" + msg);
    }

    function checkDueReminders() {
      const now = new Date();
      let changed = false;

      reminders.forEach(r => {
        const rt = new Date(r.time);
        const diff = rt.getTime() - now.getTime();
        if (diff <= 0) return;
        if (diff < 60000 && !r.notified) {
          showReminderNotification(r);
          r.notified = true;
          changed = true;
        }
      });

      if (changed) {
        localStorage.setItem("babyReminders", JSON.stringify(reminders));
        updateReminders();
      }
    }

    // -------------------------------------------------------
    // SAVE / DISPLAY
    // -------------------------------------------------------
    function saveAndRefresh() {
      localStorage.setItem("babyActivities", JSON.stringify(activities));
      updateDisplay();
    }

    function updateDisplay() {
      // datum u headeru
      const p = getTZParts(new Date(), TZ);
      document.getElementById("todayDate").textContent = `${p.day}.${p.month}.${p.year}`;

      updateRecentActivities();
      updateTodayStatsMini();
      updateLastTimes();
      renderHomeStatus();

      updateCheckups();
      updateReminders();

      // history refresh samo kad si na history (ali bez ≈°tete i ako nije)
      renderHistory();
    }

    // -------------------------------------------------------
    // NAVIGACIJA
    // -------------------------------------------------------
    function switchPage(page) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.querySelectorAll(".navit").forEach(n => n.classList.remove("active"));

      const pageEl = document.getElementById(page + "Page");
      if (pageEl) pageEl.classList.add("active");

      const nav = document.querySelector(`.navit[data-page="${page}"]`);
      if (nav) nav.classList.add("active");

      // mali UX: kad uƒëe u historiju, odmah render + scroll top
      if (page === "history") {
        window.scrollTo({ top: 0, behavior: "smooth" });
        renderHistory();
      }
    }

    // -------------------------------------------------------
    // HOME interval (aktivni procesi + podsjetnici)
    // -------------------------------------------------------
    let homeInterval = null;

    function ensureHomeIntervals() {
      if (homeInterval) return;
      homeInterval = setInterval(() => {
        if (activeSleep) updateSleepQuickButton(true);
        if (activeFeeding) updateFeedingQuickButton(true);
        updateLastTimes();
        renderHomeStatus();
        checkDueReminders();
      }, 1000);
    }

    // -------------------------------------------------------
    // INIT
    // -------------------------------------------------------
    // normalizuj stare unose (ne bri≈°e ni≈°ta)
    activities = activities.map(normalizeActivity);
    localStorage.setItem("babyActivities", JSON.stringify(activities));

    if (activeSleep) updateSleepQuickButton(true);
    if (activeFeeding) updateFeedingQuickButton(true);

    updateDisplay();
    requestNotificationPermission();
    ensureHomeIntervals();

    // osvje≈æi podsjetnike svakih 30 sekundi (bez ≈°tete)
    setInterval(updateReminders, 30000);
  </script>
</body>
</html>
